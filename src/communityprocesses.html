<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="createrecipe.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community Processes</title>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="home.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="tutorial.html">Tutorial</a></li>
      <li><a href="setuprecipe.html">Create</a></li>
      <li><a href="library.html">Library</a></li>
    </ul>
  </nav>
  
  <div class="content-wrapper">
    <aside class="sidebar">
      <nav class="sidebar-nav" id="dynamicNav">
      </nav>
    </aside>

    <main>
      <h1>Community Processes</h1>
      <h3>Set a shared understanding about how governance works in your community. Can people submit proposals, and if so how? Who can be involved in the decision-making? Is there a deliberation process? How are your rules enforced?</h3>
      
      <h2>Moderation</h2>
      <textarea id="moderation" name="moderation" placeholder="Describe your moderation process, reporting procedures, conflict resolution, disciplinary steps, warning system, etc."></textarea>
      
      <h2>Decision-making</h2>
      <textarea id="decisionMaking" name="decisionMaking" placeholder="Explain how decisions about rules, infrastructure changes, and community direction are made."></textarea>
      
      <h2>Updates</h2>
      <textarea id="updates" name="updates" placeholder="Where can people find server updates? (e.g., admin account, announcement channel, etc.)"></textarea>
      
      <h2>Feedback</h2>
      <textarea id="feedback" name="feedback" placeholder="Describe where and how people can submit feedback, requests, polls, or suggestions."></textarea>
    </main>
  </div>

  <script type="module" src="navigation.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://sewbsumjjlpsbadgwgfk.supabase.co";
    const supabaseKey = "sb_publishable_wSb8KHh3lvlLMMCxSTLQ-Q_bYqvk77x";
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function loadCommunityProcessesData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return;
      }

      const { data, error } = await supabase
        .from("communities")
        .select("communityprocesses_data")
        .eq("id", communityId)
        .single();

      if (error) {
        console.error("Error loading community processes data:", error);
        return;
      }

      if (data && data.communityprocesses_data) {
        populateForm(data.communityprocesses_data);
      }
    }

    function populateForm(processesData) {
      if (processesData.moderation) {
        document.getElementById("moderation").value = processesData.moderation;
      }

      if (processesData.decisionMaking) {
        document.getElementById("decisionMaking").value = processesData.decisionMaking;
      }

      if (processesData.updates) {
        document.getElementById("updates").value = processesData.updates;
      }

      if (processesData.feedback) {
        document.getElementById("feedback").value = processesData.feedback;
      }
    }

    function collectFormData() {
      return {
        moderation: document.getElementById("moderation").value,
        decisionMaking: document.getElementById("decisionMaking").value,
        updates: document.getElementById("updates").value,
        feedback: document.getElementById("feedback").value
      };
    }

    async function saveCommunityProcessesData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return false;
      }

      const processesData = collectFormData();

      const { error } = await supabase
        .from("communities")
        .update({ communityprocesses_data: processesData })
        .eq("id", communityId);

      if (error) {
        console.error("Error saving community processes data:", error);
        return false;
      }

      console.log("Community processes data saved successfully");
      return true;
    }

    let saveTimeout;
    function autoSaveData() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveCommunityProcessesData();
      }, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadCommunityProcessesData();

      document.getElementById("moderation").addEventListener("input", autoSaveData);
      document.getElementById("decisionMaking").addEventListener("input", autoSaveData);
      document.getElementById("updates").addEventListener("input", autoSaveData);
      document.getElementById("feedback").addEventListener("input", autoSaveData);
    });
  </script>
</body>
</html>