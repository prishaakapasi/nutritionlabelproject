<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Handjet:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="federation.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Federation</title>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="tutorial.html">Tutorial</a></li>
      <li><a href="setuprecipe.html">Create</a></li>
      <li><a href="library.html">Library</a></li>
    </ul>
  </nav>
  
  <div class="content-wrapper">
    <aside class="sidebar">
      <nav class="sidebar-nav" id="dynamicNav">
      </nav>
    </aside>

    <main>
      <h1>Federation</h1>
      <h3>Summarize your policy for federating with other servers, including those on other protocols.</h3>
      
      <h2>Federation Policy</h2>
      <div id="federationContainer" class="button-container">
        <button class="module-btn">Whitelist Mode</button>
        <button class="module-btn">Blocklist Mode</button>
        <button class="module-btn">Anti-meta Fedipact</button>
        <button class="add-module-btn">+</button>
      </div>
      <div class="new-module-container" style="display: none;">
        <input type="text" class="new-module-text" placeholder="Enter new federation policy...">
        <div class="button-group">
          <button class="save-module">Save</button>
          <button class="cancel-module">Cancel</button>
        </div>
      </div>

      <h2>Bridging Policy</h2>
      <div id="bridgingContainer" class="button-container">
        <button class="module-btn">AT Protocol</button>
        <button class="module-btn">Nostr</button>
        <button class="module-btn">Farcaster</button>
        <button class="add-module-btn">+</button>
      </div>
      <div class="new-module-container" style="display: none;">
        <input type="text" class="new-module-text" placeholder="Enter new bridging policy...">
        <div class="button-group">
          <button class="save-module">Save</button>
          <button class="cancel-module">Cancel</button>
        </div>
      </div>

      <h2>Blocklists</h2>
      <div id="blocklistsContainer" class="button-container">
        <button class="module-btn">Garden Fence</button>
        <button class="module-btn">CARIAD</button>
        <button class="module-btn">IFTAS-DNI</button>
        <button class="module-btn">Seridy Tier-0</button>
        <button class="module-btn">FediNuke</button>
      </div>
    </main>
  </div>

  <script type="module" src="navigation.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://sewbsumjjlpsbadgwgfk.supabase.co";
    const supabaseKey = "sb_publishable_wSb8KHh3lvlLMMCxSTLQ-Q_bYqvk77x";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const defaultFederation = ['Whitelist Mode', 'Blacklist Mode', 'Anti-meta Fedipact'];
    const defaultBridging = ['AT Protocol', 'Nostr', 'Farcaster'];
    const defaultBlocklists = ['Garden Fence', 'CARIAD', 'IFTAS-DNI', 'Seridy Tier-0', 'FediNuke'];

    async function loadFederationData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return;
      }

      const { data, error } = await supabase
        .from("communities")
        .select("federation_data")
        .eq("id", communityId)
        .single();

      if (error) {
        console.error("Error loading federation data:", error);
        return;
      }

      if (data && data.federation_data) {
        populateForm(data.federation_data);
      }
    }

    function populateForm(federationData) {
      if (federationData.selectedFederation && Array.isArray(federationData.selectedFederation)) {
        federationData.selectedFederation.forEach(policy => {
          const btn = Array.from(document.querySelectorAll('#federationContainer .module-btn'))
            .find(b => b.textContent === policy);
          if (btn) {
            btn.classList.add('selected');
          }
        });
      }

      if (federationData.customFederation && Array.isArray(federationData.customFederation)) {
        const container = document.getElementById('federationContainer');
        const addBtn = container.querySelector('.add-module-btn');
        
        federationData.customFederation.forEach(policy => {
          const newButton = document.createElement('button');
          newButton.className = 'module-btn';
          if (federationData.selectedFederation && federationData.selectedFederation.includes(policy)) {
            newButton.classList.add('selected');
          }
          newButton.textContent = policy;
          container.insertBefore(newButton, addBtn);
          
          newButton.addEventListener('click', function() {
            this.classList.toggle('selected');
            autoSaveData();
          });
        });
      }

      if (federationData.selectedBridging && Array.isArray(federationData.selectedBridging)) {
        federationData.selectedBridging.forEach(policy => {
          const btn = Array.from(document.querySelectorAll('#bridgingContainer .module-btn'))
            .find(b => b.textContent === policy);
          if (btn) {
            btn.classList.add('selected');
          }
        });
      }

      if (federationData.customBridging && Array.isArray(federationData.customBridging)) {
        const container = document.getElementById('bridgingContainer');
        const addBtn = container.querySelector('.add-module-btn');
        
        federationData.customBridging.forEach(policy => {
          const newButton = document.createElement('button');
          newButton.className = 'module-btn';
          if (federationData.selectedBridging && federationData.selectedBridging.includes(policy)) {
            newButton.classList.add('selected');
          }
          newButton.textContent = policy;
          container.insertBefore(newButton, addBtn);
          
          newButton.addEventListener('click', function() {
            this.classList.toggle('selected');
            autoSaveData();
          });
        });
      }

      if (federationData.selectedBlocklists && Array.isArray(federationData.selectedBlocklists)) {
        federationData.selectedBlocklists.forEach(blocklist => {
          const btn = Array.from(document.querySelectorAll('#blocklistsContainer .module-btn'))
            .find(b => b.textContent === blocklist);
          if (btn) {
            btn.classList.add('selected');
          }
        });
      }
    }

    function collectFormData() {
      const selectedFederation = [];
      document.querySelectorAll('#federationContainer .module-btn.selected').forEach(btn => {
        selectedFederation.push(btn.textContent);
      });

      const customFederation = [];
      document.querySelectorAll('#federationContainer .module-btn').forEach(btn => {
        const text = btn.textContent;
        if (!defaultFederation.includes(text) && text !== '+') {
          customFederation.push(text);
        }
      });

      const selectedBridging = [];
      document.querySelectorAll('#bridgingContainer .module-btn.selected').forEach(btn => {
        selectedBridging.push(btn.textContent);
      });

      const customBridging = [];
      document.querySelectorAll('#bridgingContainer .module-btn').forEach(btn => {
        const text = btn.textContent;
        if (!defaultBridging.includes(text) && text !== '+') {
          customBridging.push(text);
        }
      });

      const selectedBlocklists = [];
      document.querySelectorAll('#blocklistsContainer .module-btn.selected').forEach(btn => {
        selectedBlocklists.push(btn.textContent);
      });

      return {
        selectedFederation,
        customFederation,
        selectedBridging,
        customBridging,
        selectedBlocklists
      };
    }

    async function saveFederationData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return false;
      }

      const federationData = collectFormData();

      const { error } = await supabase
        .from("communities")
        .update({ federation_data: federationData })
        .eq("id", communityId);

      if (error) {
        console.error("Error saving federation data:", error);
        return false;
      }

      console.log("Federation data saved successfully");
      return true;
    }

    let saveTimeout;
    function autoSaveData() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveFederationData();
      }, 1000);
    }

    function initializeSection(containerElement) {
      const addBtn = containerElement.querySelector('.add-module-btn');
      const newModuleContainer = containerElement.nextElementSibling;
      const newModuleText = newModuleContainer.querySelector('.new-module-text');
      const saveBtn = newModuleContainer.querySelector('.save-module');
      const cancelBtn = newModuleContainer.querySelector('.cancel-module');

      addBtn.addEventListener('click', function() {
        newModuleContainer.style.display = 'block';
        newModuleText.focus();
      });

      saveBtn.addEventListener('click', function() {
        const newModule = newModuleText.value.trim();
        if (newModule) {
          const newButton = document.createElement('button');
          newButton.className = 'module-btn';
          newButton.textContent = newModule;

          newButton.addEventListener('click', function() {
            this.classList.toggle('selected');
            autoSaveData();
          });

          containerElement.insertBefore(newButton, addBtn);
          
          newModuleContainer.style.display = 'none';
          newModuleText.value = '';
          autoSaveData();
        }
      });

      cancelBtn.addEventListener('click', function() {
        newModuleContainer.style.display = 'none';
        newModuleText.value = '';
      });

      newModuleText.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          saveBtn.click();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadFederationData();

      initializeSection(document.getElementById('federationContainer'));
      initializeSection(document.getElementById('bridgingContainer'));

      document.querySelectorAll('#federationContainer .module-btn, #bridgingContainer .module-btn, #blocklistsContainer .module-btn').forEach(btn => {
        if (!btn.classList.contains('add-module-btn')) {
          btn.addEventListener('click', function() {
            this.classList.toggle('selected');
            autoSaveData();
          });
        }
      });
    });
  </script>
</body>
</html>