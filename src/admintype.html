<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="createrecipe.css" />
    <link rel="stylesheet" href="mastersheet.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Handjet:wght@100..900&display=swap" rel="stylesheet">
    <title> Admin Type</title>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="tutorial.html">Tutorial</a></li>
      <li><a href="setuprecipe.html">Create</a></li>
      <li><a href="library.html">Library</a></li>
    </ul>
  </nav>
  
  <div class="content-wrapper">
    <aside class="sidebar">
      <nav class="sidebar-nav" id="dynamicNav">
      </nav>
    </aside>

    <main>
      <h1>Admin Type</h1>
      <h3>Let people know who administers and moderates the community space.</h3>
      <div id="modulesContainer" class="button-container">
        <button class="module-btn">Team</button>
        <button class="module-btn">Cooperative</button>
        <button class="module-btn">Benevolent Dictator</button>
        <button id="addModuleBtn">+</button>
      </div>
      
      <div id="newModuleContainer" style="display: none;">
        <input type="text" id="newModuleText" placeholder="Enter new admin type...">
        <div class="button-group">
          <button id="saveModule">Save</button>
          <button id="cancelModule">Cancel</button>
        </div>
      </div>

      <h2>Add Usernames of Admins</h2>
      <div id="adminList" class="covenant-list"></div>
      <button id="addAdminBtn" class="add-btn">+ Add Admin</button>
    </main>
  </div>

  <script type="module" src="navigation.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://sewbsumjjlpsbadgwgfk.supabase.co";
    const supabaseKey = "sb_publishable_wSb8KHh3lvlLMMCxSTLQ-Q_bYqvk77x";
    const supabase = createClient(supabaseUrl, supabaseKey);

    let admins = [];

    function createAdminItem(username = '') {
      const item = document.createElement('div');
      item.className = 'covenant-item';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'ex: https://server/@user';
      input.value = username;
      input.addEventListener('input', () => {
        updateAdminsArray();
        autoSaveData();
      });
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'âˆ’';
      removeBtn.addEventListener('click', () => {
        item.remove();
        updateAdminsArray();
        autoSaveData();
      });
      
      item.appendChild(input);
      item.appendChild(removeBtn);
      
      return item;
    }

    function updateAdminsArray() {
      const adminInputs = document.querySelectorAll('#adminList input');
      admins = Array.from(adminInputs)
        .map(input => input.value.trim())
        .filter(value => value !== '');
    }

    async function loadAdminData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return;
      }

      const { data, error } = await supabase
        .from("communities")
        .select("admin_data")
        .eq("id", communityId)
        .single();

      if (error) {
        console.error("Error loading admin data:", error);
        return;
      }

      if (data && data.admin_data) {
        populateForm(data.admin_data);
      } else {
        document.getElementById('adminList').appendChild(createAdminItem());
      }
    }

    function populateForm(adminData) {
      if (adminData.selectedType) {
        const buttons = document.querySelectorAll('.module-btn');
        buttons.forEach(btn => {
          if (btn.textContent === adminData.selectedType) {
            btn.classList.add('selected');
          }
        });
      }

      if (adminData.customTypes && Array.isArray(adminData.customTypes)) {
        const modulesContainer = document.getElementById('modulesContainer');
        const addBtn = document.getElementById('addModuleBtn');
        
        adminData.customTypes.forEach(type => {
          const newButton = document.createElement('button');
          newButton.className = 'module-btn';
          if (type === adminData.selectedType) {
            newButton.classList.add('selected');
          }
          newButton.textContent = type;
          modulesContainer.insertBefore(newButton, addBtn);
          
          newButton.addEventListener('click', function() {
            document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            autoSaveData();
          });
        });
      }

      const adminList = document.getElementById('adminList');
      adminList.innerHTML = '';
      
      if (adminData.usernames && Array.isArray(adminData.usernames) && adminData.usernames.length > 0) {
        adminData.usernames.forEach(username => {
          adminList.appendChild(createAdminItem(username));
        });
      } else {
        adminList.appendChild(createAdminItem());
      }
      
      updateAdminsArray();
    }

    function collectFormData() {
      const selectedBtn = document.querySelector('.module-btn.selected');
      const defaultTypes = ['Benevolent Dictator', 'Cooperative', 'Team'];
      
      const customTypes = [];
      document.querySelectorAll('.module-btn').forEach(btn => {
        const text = btn.textContent;
        if (!defaultTypes.includes(text)) {
          customTypes.push(text);
        }
      });

      updateAdminsArray();

      return {
        selectedType: selectedBtn ? selectedBtn.textContent : null,
        customTypes: customTypes,
        usernames: admins
      };
    }

    async function saveAdminData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return false;
      }

      const adminData = collectFormData();

      const { error } = await supabase
        .from("communities")
        .update({ admin_data: adminData })
        .eq("id", communityId);

      if (error) {
        console.error("Error saving admin data:", error);
        return false;
      }

      console.log("Admin data saved successfully");
      return true;
    }

    let saveTimeout;
    function autoSaveData() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveAdminData();
      }, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadAdminData();

      document.getElementById('addAdminBtn').addEventListener('click', () => {
        document.getElementById('adminList').appendChild(createAdminItem());
      });

      document.querySelectorAll('.module-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          autoSaveData();
        });
      });

      const addModuleBtn = document.getElementById('addModuleBtn');
      const newModuleContainer = document.getElementById('newModuleContainer');
      const newModuleText = document.getElementById('newModuleText');
      const saveModule = document.getElementById('saveModule');
      const cancelModule = document.getElementById('cancelModule');
      const modulesContainer = document.getElementById('modulesContainer');

      addModuleBtn.addEventListener('click', function() {
        newModuleContainer.style.display = 'block';
        newModuleText.focus();
      });

      saveModule.addEventListener('click', function() {
        const newModule = newModuleText.value.trim();
        if (newModule) {
          const newButton = document.createElement('button');
          newButton.className = 'module-btn';
          newButton.textContent = newModule;

          newButton.addEventListener('click', function() {
            document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            autoSaveData();
          });

          modulesContainer.insertBefore(newButton, addModuleBtn);
          
          newModuleContainer.style.display = 'none';
          newModuleText.value = '';
          
          autoSaveData();
        }
      });

      cancelModule.addEventListener('click', function() {
        newModuleContainer.style.display = 'none';
        newModuleText.value = '';
      });

      newModuleText.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          saveModule.click();
        }
      });
    });
  </script>
</body>
</html>