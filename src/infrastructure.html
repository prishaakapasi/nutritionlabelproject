<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Handjet:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="mastersheet.css" /> 
    <link rel="stylesheet" href="infrastructure.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infrastructure</title>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="tutorial.html">Tutorial</a></li>
      <li><a href="setuprecipe.html">Create</a></li>
      <li><a href="library.html">Library</a></li>
    </ul>
  </nav>
  
 <div class="content-wrapper">
    <aside class="sidebar">
      <nav class="sidebar-nav" id="dynamicNav">
      </nav>
    </aside>

    <main>
      <h1>Infrastructure</h1>
      <h3>Give people some insight into the technical infrastructure that your community sits on.</h3>
      
      <h2>Protocol</h2>
      <input id="protocols" name="protocols" placeholder="Describe the protocol(s) your community uses..."></input>
      <h2>Software</h2>
      <div class="software-container">
        <input
          type="text"
          id="software"
          placeholder="Start typing to search or type your own"
          autocomplete="off"
        />
        <div class="software-hint">Choose one or type your own software</div>
        <ul id="software-dropdown" class="software-dropdown"></ul>
      </div>

      <h2>Hosting</h2>
      <div class="button-container">
        <button class="hosting-btn" data-type="physical">Physical</button>
        <button class="hosting-btn" data-type="cloud">Cloud</button>
      </div>
      
      <div id="hostingDescription" style="display: none;">
        <input type="text" id="hostingDetails" placeholder=" e.g in admin basement">
      </div>
      
            <h2 class="costs-label">
            Costs
        <span class="info-tooltip">
          ⓘ
          <span class="tooltip-text"> Cost of running the server          </span>
        </span>
      </h2>
      <textarea id="costs" name="costs" placeholder="Funded by admin"></textarea>
      
      <h2> Community Links</h2>
      <div id="channelsList" class="channels-list"></div>
      <div class="channel-input-container">
        <input type="url" id="channelUrl" placeholder="https://discord.gg/example or https://loomio.org/example">
        <button id="addChannel" class="save-module">Add Links <Channel></button>
      </div>
    </main>
  </div>

  <script type="module" src="navigation.js"></script>
  
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://sewbsumjjlpsbadgwgfk.supabase.co";
    const supabaseKey = "sb_publishable_wSb8KHh3lvlLMMCxSTLQ-Q_bYqvk77x";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const hostingBtns = document.querySelectorAll('.hosting-btn');
    const hostingDescription = document.getElementById('hostingDescription');
    const hostingDetails = document.getElementById('hostingDetails');
    const channelUrl = document.getElementById('channelUrl');
    const addChannelBtn = document.getElementById('addChannel');
    const channelsList = document.getElementById('channelsList');
    function normalizeUrl(url) {
          if (!/^https?:\/\//i.test(url)) {
            return "https://" + url;
          }
          return url;
        }


    function detectPlatform(url) {
      url = url.toLowerCase();
      
      if (url.includes('discord')) return 'Discord';
      if (url.includes('loomio')) return 'Loomio';
      if (url.includes('slack')) return 'Slack';
      if (url.includes('telegram')) return 'Telegram';
      if (url.includes('matrix')) return 'Matrix';
      if (url.includes('github')) return 'GitHub';
      if (url.includes('gitlab')) return 'GitLab';
      if (url.includes('reddit')) return 'Reddit';
      if (url.includes('twitter') || url.includes('x.com')) return 'Twitter/X';
      if (url.includes('facebook')) return 'Facebook';
      
      return 'Link';
    }

    async function loadInfrastructureData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return;
      }

      const { data, error } = await supabase
        .from("communities")
        .select("infrastructure_data")
        .eq("id", communityId)
        .single();

      if (error) {
        console.error("Error loading infrastructure data:", error);
        return;
      }

      if (data && data.infrastructure_data) {
        populateForm(data.infrastructure_data);
      }
    }

    function populateForm(infrastructureData) {
      if (infrastructureData.protocol) {
        document.getElementById("protocols").value = infrastructureData.protocol;
      }

      if (infrastructureData.software) {
        document.getElementById("software").value = infrastructureData.software;
      }

      if (infrastructureData.hostingType) {
        const hostingBtn = document.querySelector(`[data-type="${infrastructureData.hostingType}"]`);
        if (hostingBtn) {
          hostingBtn.click();
        }
      }

      if (infrastructureData.hostingDetails) {
        document.getElementById("hostingDetails").value = infrastructureData.hostingDetails;
      }

      if (infrastructureData.costs) {
        document.getElementById("costs").value = infrastructureData.costs;
      }

      if (infrastructureData.channels && Array.isArray(infrastructureData.channels)) {
        infrastructureData.channels.forEach(channel => {
          const platform = detectPlatform(channel.url);
          
          const channelItem = document.createElement("div");
          channelItem.className = "channel-item";
          
          const channelBtn = document.createElement("a");
          channelBtn.className = "channel-btn";
          channelBtn.href = normalizeUrl(channel.url);
          channelBtn.target = "_blank";
          channelBtn.textContent = platform.toUpperCase();
          
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-channel-btn";
          removeBtn.textContent = "×";
          removeBtn.addEventListener("click", function() {
            channelItem.remove();
            autoSaveData();
          });
          
          channelItem.appendChild(channelBtn);
          channelItem.appendChild(removeBtn);
          channelsList.appendChild(channelItem);
        });
      }
    }

    function collectFormData() {
      const channels = [];
      document.querySelectorAll(".channel-item").forEach(item => {
        const link = item.querySelector(".channel-btn");
        if (link) {
          channels.push({
            url: link.href,
            platform: link.textContent
          });
        }
      });

      const hostingType = document.querySelector(".hosting-btn.selected")?.dataset.type || null;

      return {
        protocol: document.getElementById("protocols").value,
        software: document.getElementById("software").value,
        hostingType: hostingType,
        hostingDetails: document.getElementById("hostingDetails").value,
        costs: document.getElementById("costs").value,
        channels: channels
      };
    }

    async function saveInfrastructureData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return false;
      }

      const infrastructureData = collectFormData();

      const { error } = await supabase
        .from("communities")
        .update({ infrastructure_data: infrastructureData })
        .eq("id", communityId);

      if (error) {
        console.error("Error saving infrastructure data:", error);
        return false;
      }

      console.log("Infrastructure data saved successfully");
      return true;
    }

    let saveTimeout;
    function autoSaveData() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveInfrastructureData();
      }, 1000);
    }

    hostingBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        hostingBtns.forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        
        hostingDescription.style.display = 'block';
        
        if (this.dataset.type === 'physical') {
          hostingDetails.placeholder = 'e.g. in admin basement';
        } else {
          hostingDetails.placeholder = 'e.g., AWS, Google Cloud, Co-op Cloud';
        }
        
        hostingDetails.value = '';
        autoSaveData();
      });
    });

        addChannelBtn.addEventListener('click', function() {
      let url = channelUrl.value.trim();
      if (!url) return;

      url = normalizeUrl(url);
      const platform = detectPlatform(url);

      const channelItem = document.createElement('div');
      channelItem.className = 'channel-item';

      const channelBtn = document.createElement('a');
      channelBtn.className = 'channel-btn';
      channelBtn.href = url;
      channelBtn.target = '_blank';
      channelBtn.rel = 'noopener noreferrer';
      channelBtn.textContent = platform.toUpperCase();

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-channel-btn';
      removeBtn.textContent = '×';
      removeBtn.addEventListener('click', function() {
        channelItem.remove();
        autoSaveData();
      });

      channelItem.appendChild(channelBtn);
      channelItem.appendChild(removeBtn);
      channelsList.appendChild(channelItem);

      channelUrl.value = '';
      autoSaveData();
    });

    channelUrl.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        addChannelBtn.click();
      }
    });

    const softwareOptions = [
      "Mastodon", "Pixelfed", "Lemmy", "PeerTube", "WordPress", "Misskey",
      "Pleroma", "WriteFreely", "Fedibird", "NodeBB", "Activity Relay",
      "Micro.blog", "Akkoma", "Firefish", "BookWyrm", "Sharkey",
      "Hometown", "Friendica", "Loops", "PieFed", "NeoDB", "Hubzilla",
      "Forgejo", "Mbin", "Iceshrimp", "Wafrn", "Funkwhale", "KmyBlue",
      "Owncast", "FoundKey", "Gitea", "GNU social", "Mitra", "CherryPick",
      "Meisskey", "Vernissage", "Smithereen", "Hollo", "Ghost", "Snac",
      "GoToSocial", "Postmarks", "Betula", "Microblog.pub", "Manyfold",
      "Hackers' Pub", "Ktistec", "Takahē", "Stegodon", "Mobilizon",
      "Frequency", "Gancio", "Drupal", "Plume", "Flipboard", "Loforo",
      "Brutalinks", "Zap", "Ecko", "Irwin", "Honk", "Lotide", "Emissary",
      "Bonfire", "Bridgy Fed"
    ];

    const softwareInput = document.getElementById("software");
    const softwareDropdown = document.getElementById("software-dropdown");

    softwareInput.addEventListener("input", () => {
      const value = softwareInput.value.toLowerCase();
      softwareDropdown.innerHTML = "";

      if (!value) {
        softwareDropdown.style.display = "none";
        return;
      }

      const filtered = softwareOptions.filter(opt =>
        opt.toLowerCase().includes(value)
      );

      filtered.forEach(opt => {
        const li = document.createElement("li");
        li.textContent = opt;
        li.addEventListener("click", () => {
          softwareInput.value = opt;
          softwareDropdown.style.display = "none";
          autoSaveData();
        });
        softwareDropdown.appendChild(li);
      });

      softwareDropdown.style.display = filtered.length ? "block" : "none";
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".software-container")) {
        softwareDropdown.style.display = "none";
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadInfrastructureData();

      document.getElementById("protocols").addEventListener("input", autoSaveData);
      document.getElementById("software").addEventListener("input", autoSaveData);
      document.getElementById("hostingDetails").addEventListener("input", autoSaveData);
      document.getElementById("costs").addEventListener("input", autoSaveData);
    });
  </script>
</body>
</html>