<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="legalcompliance.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community - Legal Compliance</title>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="tutorial.html">Tutorial</a></li>
      <li><a href="setuprecipe.html">Create</a></li>
      <li><a href="library.html">Library</a></li>
    </ul>
  </nav>
  
  <div class="content-wrapper">
    <aside class="sidebar">
      <nav class="sidebar-nav" id="dynamicNav">
      </nav>
    </aside>

    <main>
      <h1>Legal Compliance</h1>
      <h3>Let people know what laws you need to comply with to keep the community up and running.</h3>
      
      <h2>Based In</h2>
      <select id="country" name="country">
        <option value="">Select a country...</option>
        <option value="US">United States</option>
        <option value="GB">United Kingdom</option>
        <option value="CA">Canada</option>
        <option value="AU">Australia</option>
        <option value="DE">Germany</option>
        <option value="FR">France</option>
        <option value="JP">Japan</option>
        <option value="NL">Netherlands</option>
        <option value="SE">Sweden</option>
        <option value="other">Other</option>
      </select>
      <p class="note">This is where your server is located and/or obligated to comply with local laws.</p>
      
      <h2>Relevant Regulations</h2>
      <div id="regulationsContainer" class="button-container">
        <button class="regulation-btn" data-regulation="dmca">DMCA</button>
        <button class="regulation-btn" data-regulation="gdpr">GDPR</button>
        <button class="regulation-btn" data-regulation="dsa">Digital Services Act (DSA)</button>
        <button class="add-module-btn">+</button>
      </div>
      <div class="new-module-container" style="display: none;">
        <input type="text" class="new-module-text" placeholder="Enter new regulation...">
        <div class="button-group">
          <button class="save-module">Save</button>
          <button class="cancel-module">Cancel</button>
        </div>
      </div>
      
      <div id="dmcaInfo" class="regulation-info" style="display: none;">
        <h2>DMCA Registered Agent Information</h2>
        <input type="text" id="dmcaAgentName" placeholder="Agent Name">
        <input type="text" id="dmcaAgentAddress" placeholder="Address">
        <input type="email" id="dmcaAgentEmail" placeholder="Email">
        <input type="tel" id="dmcaAgentPhone" placeholder="Phone">
      </div>
    </main>
  </div>

  <script type="module" src="navigation.js"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://sewbsumjjlpsbadgwgfk.supabase.co";
    const supabaseKey = "sb_publishable_wSb8KHh3lvlLMMCxSTLQ-Q_bYqvk77x";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const defaultRegulations = ['DMCA', 'GDPR', 'Digital Services Act (DSA)'];

    async function loadLegalComplianceData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return;
      }

      const { data, error } = await supabase
        .from("communities")
        .select("legalcompliance_data")
        .eq("id", communityId)
        .single();

      if (error) {
        console.error("Error loading legal compliance data:", error);
        return;
      }

      if (data && data.legalcompliance_data) {
        populateForm(data.legalcompliance_data);
      }
    }

    function populateForm(legalData) {
      if (legalData.country) {
        document.getElementById("country").value = legalData.country;
      }

      if (legalData.selectedRegulations && Array.isArray(legalData.selectedRegulations)) {
        legalData.selectedRegulations.forEach(regulation => {
          const btn = Array.from(document.querySelectorAll('.regulation-btn'))
            .find(b => b.textContent === regulation);
          if (btn) {
            btn.classList.add('selected');
            if (btn.dataset.regulation === 'dmca') {
              document.getElementById('dmcaInfo').style.display = 'block';
            }
          }
        });
      }

      if (legalData.customRegulations && Array.isArray(legalData.customRegulations)) {
        const container = document.getElementById('regulationsContainer');
        const addBtn = container.querySelector('.add-module-btn');
        
        legalData.customRegulations.forEach(regulation => {
          const newButton = document.createElement('button');
          newButton.className = 'regulation-btn';
          if (legalData.selectedRegulations && legalData.selectedRegulations.includes(regulation)) {
            newButton.classList.add('selected');
          }
          newButton.textContent = regulation;
          
          newButton.addEventListener('click', function() {
            this.classList.toggle('selected');
            autoSaveData();
          });

          container.insertBefore(newButton, addBtn);
        });
      }

      if (legalData.dmcaAgent) {
        if (legalData.dmcaAgent.name) {
          document.getElementById('dmcaAgentName').value = legalData.dmcaAgent.name;
        }
        if (legalData.dmcaAgent.address) {
          document.getElementById('dmcaAgentAddress').value = legalData.dmcaAgent.address;
        }
        if (legalData.dmcaAgent.email) {
          document.getElementById('dmcaAgentEmail').value = legalData.dmcaAgent.email;
        }
        if (legalData.dmcaAgent.phone) {
          document.getElementById('dmcaAgentPhone').value = legalData.dmcaAgent.phone;
        }
      }
    }

    function collectFormData() {
      const selectedRegulations = [];
      document.querySelectorAll('.regulation-btn.selected').forEach(btn => {
        selectedRegulations.push(btn.textContent);
      });

      const customRegulations = [];
      document.querySelectorAll('.regulation-btn').forEach(btn => {
        const text = btn.textContent;
        if (!defaultRegulations.includes(text) && text !== '+') {
          customRegulations.push(text);
        }
      });

      const dmcaAgent = {
        name: document.getElementById('dmcaAgentName').value,
        address: document.getElementById('dmcaAgentAddress').value,
        email: document.getElementById('dmcaAgentEmail').value,
        phone: document.getElementById('dmcaAgentPhone').value
      };

      return {
        country: document.getElementById('country').value,
        selectedRegulations,
        customRegulations,
        dmcaAgent
      };
    }

    async function saveLegalComplianceData() {
      const communityId = localStorage.getItem("communityId");
      if (!communityId) {
        console.error("No community ID found");
        return false;
      }

      const legalData = collectFormData();

      const { error } = await supabase
        .from("communities")
        .update({ legalcompliance_data: legalData })
        .eq("id", communityId);

      if (error) {
        console.error("Error saving legal compliance data:", error);
        return false;
      }

      console.log("Legal compliance data saved successfully");
      return true;
    }

    let saveTimeout;
    function autoSaveData() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveLegalComplianceData();
      }, 1000);
    }

    const regulationsContainer = document.getElementById('regulationsContainer');
    const addBtn = regulationsContainer.querySelector('.add-module-btn');
    const newModuleContainer = document.querySelector('.new-module-container');
    const newModuleText = newModuleContainer.querySelector('.new-module-text');
    const saveBtn = newModuleContainer.querySelector('.save-module');
    const cancelBtn = newModuleContainer.querySelector('.cancel-module');
    const dmcaInfo = document.getElementById('dmcaInfo');

    document.addEventListener("DOMContentLoaded", () => {
      loadLegalComplianceData();

      document.getElementById('country').addEventListener('change', autoSaveData);
      document.getElementById('dmcaAgentName').addEventListener('input', autoSaveData);
      document.getElementById('dmcaAgentAddress').addEventListener('input', autoSaveData);
      document.getElementById('dmcaAgentEmail').addEventListener('input', autoSaveData);
      document.getElementById('dmcaAgentPhone').addEventListener('input', autoSaveData);

      document.querySelectorAll('.regulation-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('selected');
          
          if (this.dataset.regulation === 'dmca') {
            dmcaInfo.style.display = this.classList.contains('selected') ? 'block' : 'none';
          }
          
          autoSaveData();
        });
      });

      addBtn.addEventListener('click', function() {
        newModuleContainer.style.display = 'block';
        newModuleText.focus();
      });

      saveBtn.addEventListener('click', function() {
        const newRegulation = newModuleText.value.trim();
        if (newRegulation) {
          const newButton = document.createElement('button');
          newButton.className = 'regulation-btn';
          newButton.textContent = newRegulation;
          
          newButton.addEventListener('click', function() {
            this.classList.toggle('selected');
            autoSaveData();
          });

          regulationsContainer.insertBefore(newButton, addBtn);
          
          newModuleContainer.style.display = 'none';
          newModuleText.value = '';
          autoSaveData();
        }
      });

      cancelBtn.addEventListener('click', function() {
        newModuleContainer.style.display = 'none';
        newModuleText.value = '';
      });

      newModuleText.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          saveBtn.click();
        }
      });
    });
  </script>
</body>
</html>